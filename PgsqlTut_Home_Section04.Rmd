---
title: "PostgreSQL Tutorial - Home - Section 4"
output: 
  html_notebook:
    theme: cerulean
    highlight: espresso
---

# Joining Multiple Tables

## Joins

Load libraries.
```{r}
library(DBI)
library(odbc)
library(RPostgres)
```

Connect to _**example**_ database.

```{r}
con_ex <- dbConnect(odbc::odbc(), "PostgreSQL AWS example")
```

Set up sample tables.

```{sql connection=con_ex}
CREATE TABLE IF NOT EXISTS basket_a (
  id     INT           PRIMARY KEY,
  fruit  VARCHAR(100)  NOT NULL
);
```

```{sql connection=con_ex}
CREATE TABLE IF NOT EXISTS basket_b (
  id     INT           PRIMARY KEY,
  fruit  VARCHAR(100)  NOT NULL
);
```

```{sql connection=con_ex}
INSERT INTO basket_a (id, fruit)
VALUES
 (1, 'Apple'),
 (2, 'Orange'),
 (3, 'Banana'),
 (4, 'Cucumber');
```

```{sql connection=con_ex}
INSERT INTO basket_b (id, fruit)
VALUES
  (1, 'Orange'),
  (2, 'Apple'),
  (3, 'Watermelon'),
  (4, 'Pear');
```

```{sql connection=con_ex}
SELECT * FROM basket_a;
```

```{sql connection=con_ex}
SELECT * FROM basket_b;
```

### PostgreSQL inner join

```{sql connection=con_ex}
SELECT
  a.id,
  a.fruit,
  b.id,
  b.fruit
FROM
  basket_a AS a
INNER JOIN
  basket_b AS b 
  ON a.fruit = b.fruit;
```

### PostgreSQL left outer join

```{sql connection=con_ex}
SELECT
  a.id,
  a.fruit,
  b.id,
  b.fruit
FROM
  basket_a AS a
LEFT OUTER JOIN
  basket_b AS b
  ON a.fruit = b.fruit;
```

### PostgreSQL left outer join (where right table key is null)

```{sql connection=con_ex}
SELECT
  a.id,
  a.fruit,
  b.id,
  b.fruit
FROM
  basket_a AS a
LEFT OUTER JOIN
  basket_b AS b
  ON a.fruit = b.fruit
WHERE b.fruit IS NULL;
```

### PostgreSQL right outer join

```{sql connection=con_ex}
SELECT
  a.id,
  a.fruit,
  b.id,
  b.fruit
FROM
  basket_a AS a
RIGHT OUTER JOIN
  basket_b AS b
  ON a.fruit = b.fruit;
```

### PostgreSQL right outer join (where left table key is null)

```{sql connection=con_ex}
SELECT
  a.id,
  a.fruit,
  b.id,
  b.fruit
FROM
  basket_a AS a
RIGHT OUTER JOIN
  basket_b AS b
  ON a.fruit = b.fruit
WHERE a.fruit IS NULL;
```

### PostgreSQL full outer join

```{sql connection=con_ex}
SELECT
  a.id,
  a.fruit,
  b.id,
  b.fruit
FROM
  basket_a AS a
FULL OUTER JOIN
  basket_b AS b
  ON a.fruit = b.fruit;
```

### PostgreSQL full outer join (where left and right table keys are null)

```{sql connection=con_ex}
SELECT
  a.id,
  a.fruit,
  b.id,
  b.fruit
FROM
  basket_a AS a
FULL OUTER JOIN
  basket_b AS b
  ON a.fruit = b.fruit
WHERE a.id IS NULL OR b.id IS NULL;
```

Disconnect from _**example**_ database.
```{r}
dbDisconnect(con_ex)
```


## INNER JOIN

Using the _**dvdrental**_ database...
```{r}
con_dvd <- dbConnect(odbc::odbc(), "PostgreSQL AWS dvdrental")
```

... we'll join the "customer" and "payment" tables.

```{sql connection=con_dvd}
SELECT
  c.customer_id,
  c.first_name,
  c.last_name,
  c.email,
  p.amount,
  p.payment_date
FROM
  customer AS c
INNER JOIN
  payment AS p
  ON c.customer_id = p.customer_id;
```

Add `ORDER BY` clause to sort by `customer_id` and `payment_date`.
```{sql connection=con_dvd}
SELECT
  c.customer_id,
  c.first_name,
  c.last_name,
  c.email,
  p.amount,
  p.payment_date
FROM
  customer AS c
INNER JOIN
  payment AS p
  ON c.customer_id = p.customer_id
ORDER BY
  c.customer_id, p.payment_date;
```

Add `WHERE` clause to filter.
```{sql connection=con_dvd}
SELECT
  c.customer_id,
  c.first_name,
  c.last_name,
  c.email,
  p.amount,
  p.payment_date
FROM
  customer AS c
INNER JOIN
  payment AS p
  ON c.customer_id = p.customer_id
WHERE
  c.customer_id = 2;
```

### INNER JOIN to join 3 tables

```{sql connection=con_dvd}
SELECT
  c.customer_id,
  c.first_name AS c_first_name,
  c.last_name AS c_last_name,
  c.email,
  s.first_name AS s_first_name,
  s.last_name AS s_last_name,
  p.amount,
  p.payment_date
FROM
  customer AS c
INNER JOIN
  payment AS p
  ON c.customer_id = p.customer_id
INNER JOIN
  staff AS s
  ON p.staff_id = s.staff_id;
```

Disconnect from _**dvdrental**_ database.
```{r}
dbDisconnect(con_dvd)
```


## LEFT JOIN

Connect to _**dvdrental**_ database.
```{r}
con_dvd <- dbConnect(odbc::odbc(), "PostgreSQL AWS dvdrental")
```

Left join "film" and "inventory" tables.
```{sql connection=con_dvd}
SELECT
  f.film_id,
  f.title,
  i.inventory_id
FROM
  film AS f
LEFT JOIN
  inventory AS i
  ON f.film_id = i.film_id;
-- WHERE i.inventory_id IS NULL; -- revealse right table NULLs
-- ORDER BY f.film_id;
```

Disconnect from _**dvdrental**_ database.
```{r}
dbDisconnect(con_dvd)
```


## SELF JOIN

Self-joins are useful for comparing rows within the same table.

Connect to the _**example**_ database.
```{r}
con_ex <- dbConnect(odbc::odbc(), "PostgreSQL AWS example")
```

### 1. Querying hierarchy data example

Set up a table based on the hierarchical reporting structure depicted in "PostgreSQL-Self-Join-Reporting-Structure.png".

Create an "employee" table.
```{sql connection=con_ex}
DROP TABLE IF EXISTS employee;
```

```{sql connection=con_ex}
CREATE TABLE IF NOT EXISTS employee(
  employee_id  INT           PRIMARY KEY,
  first_name   VARCHAR(255)  NOT NULL,
  last_name    VARCHAR(255)  NOT NULL,
  manager_id   INT,
  FOREIGN KEY (manager_id) REFERENCES employee (employee_id)
  ON DELETE CASCADE
);
```

Insert data into the "employee" table.
```{sql connection=con_ex}
INSERT INTO employee(
  employee_id, first_name, last_name, manager_id
) 
VALUES
  (1, 'Windy',  'Hays',       NULL),
  (2, 'Hasan',  'Conner',     1),
  (3, 'Ava',    'Christensn', 1),
  (4, 'Salley', 'Lester',     2),
  (5, 'Kelsie', 'Hays',       2),
  (6, 'Tory',   'Goff',       2),
  (7, 'Sau',    'Norman',     3),
  (8, 'Anna',   'Reeves',     3);
```

To find who reports to whom, use this INNER JOIN.
```{sql connection=con_ex}
SELECT
  e1.first_name || ' ' || e1.last_name AS employee_name,
  e2.first_name || ' ' || e2.last_name AS manager_name
FROM
  employee AS e1
INNER JOIN
  employee AS e2
  ON e1.manager_id = e2.employee_id
ORDER BY manager_name DESC;
```

A `LEFT OUTER JOIN` is required to include the top manager (Windy Hays) in result.
```{sql connection=con_ex}
SELECT
  e1.first_name || ' ' || e1.last_name AS employe_name,
  e2.first_name || ' ' || e2.last_name AS manager_name
FROM
  employee AS e1
LEFT OUTER JOIN
  employee AS e2
  ON e1.manager_id = e2.employee_id
ORDER BY
  manager_name DESC;
```

Disconnect from _**example**_ database.
```{r}
dbDisconnect(con_ex)
```


### 2. Comparing the rows with the same table

Connect to the _**dvdrental**_ database.
```{r}
con_dvd <- dbConnect(odbc::odbc(), "PostgreSQL AWS dvdrental")
```

The following query finds all pairs of films that have the same length.

```{sql connection=con_dvd}
SELECT
  f1.film_id,
  f1.title,
  f2.title,
  f1.length AS f1_length
FROM
  film AS f1
INNER JOIN
  film AS f2
  ON f1.length = f2.length;
-- ORDER BY
--   f1.film_id;
```

Disconnect from _**dvdrental**_ database.
```{r}
dbDisconnect(con_dvd)
```





























